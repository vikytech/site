@startuml "QR-auth-userflow"

' Configurations
' ------------
!pragma teoz true

autonumber
hide unlinked

' Customization
' ------------
skinparam {
    BackgroundColor White
    sequenceArrowThickness 2
    sequenceReferenceAlign center
    ParticipantPadding 5
    BoxPadding 50
    lifelineStrategy nosolid

    roundcorner 15
    maxmessagesize 300
    PageMargin 20
    Legend {
        FontStyle bold
        Padding 1
    }
    Note {
        BackgroundColor #WhiteSmoke
    }
}

!$spmColor="#LightPink"
!$rpColor="#SkyBlue"
!$aspColor="#PaleGreen"

' Declarations
' ------------
title "QR based Authentication"

actor "User" as user

participant "Mobile App" as spm $spmColor
participant "Client (frontend)" as rp $rpColor
participant "Authenticator(backend)" as asp $aspColor

' User Flow
' ------------
activate rp $rpColor
user -> rp: visit \n https://client.com/login
rp --> asp: /auth
deactivate rp

activate asp $aspColor
asp --> asp: * retrive client details\n*create auth_ref
asp -> rp: auth_ref
deactivate asp

rnote over rp
                        Generate QR
    using the auth_ref generated by backend
end note

activate spm $spmColor
spm -> rp: Scan QR using mobile app
spm -> asp: /auth-session/<auth_ref>/verification along with the user details
deactivate spm

activate asp $aspColor
asp --> asp: * Validate auth_ref\n* Validate User and Cert
asp -> spm: "OK"
asp --> asp: * Generate auth code
asp -> rp: Respond with "SUCCESS"\nwith auth code generated
activate rp $rpColor

rp -> asp: /token?code=AUTH_CODE
asp --> asp: * Retrive client details
asp --> asp: * Validate Session
asp -> rp: Receives IDToken\n to complete the login process
deactivate asp
rp --> rp: User Session created

rp -> user: User Logged in successfully !!!!
deactivate rp

@enduml